name: Docs CI Windows

run-name: >-
    Docs CI Windows [Build #${{ inputs.build }} 
                          Version: ${{ inputs.version }}
                    ]
                    [
                    ${{ inputs.community && 'CE' || '-' }}
                    ${{ inputs.enterprise && 'EE' || '-' }}
                    ]

on:
  #push:
  workflow_dispatch:
    inputs:
      build:
        description: 'Please specify windows package build'
        type: string
        required: true
      version:
        description: 'Please specify windows package version'
        type: string
        required: true
      community:
        type: boolean
        description: 'Test Exe Community Edition'
        default: true
      enterprise:
        type: boolean
        description: 'Test Exe Enterprise Edition'
        default: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - id: matrix
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          COMMUNITY: ${{ github.event.inputs.community }}
          ENTERPRISE: ${{ github.event.inputs.enterprise }}
        run: |
          set -ex

          [ "${COMMUNITY}" = true ] && EDITIONS+=("community")
          [ "${ENTERPRISE}" = true ] && EDITIONS+=("enterprise")
          if [ -z ${EDITIONS} ]; then
            echo "None of the editions are selected."
            exit 1
          fi
          echo "editions=$(jq -n -c --arg s "${EDITIONS[*]}" '($s|split(" "))')" >> $GITHUB_OUTPUT
    outputs:
      editions: ${{ steps.matrix.outputs.editions }}

  test:
    name: "CI Docs-Desktop-${{ matrix.edition }}-${{ github.event.inputs.version }}"
    needs: prepare
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        edition: ${{ fromJSON(needs.prepare.outputs.editions) }}
    env:
      VERSION: ${{ github.event.inputs.version }}
      BUILD: ${{ github.event.inputs.build }}
      EDITION: ${{ matrix.edition }}
    steps:
    - name: Init env
      shell: pwsh
      run: |
          switch ($env:EDITION) {
            "community"  { $PRODUCT_EDITION = "" }
            "enterprise" { $PRODUCT_EDITION = "-Enterprise" }
          }

          echo "PRODUCT_EDITION=$PRODUCT_EDITION"  | Out-File -Append -FilePath $env:GITHUB_ENV
          echo "VERSION=$($env:VERSION)"           | Out-File -Append -FilePath $env:GITHUB_ENV
          echo "BUILD=$($env:BUILD)"               | Out-File -Append -FilePath $env:GITHUB_ENV
          
    - name: Download
      shell: pwsh
      run: |
          $url    = "${{ secrets.PACKAGE_URL }}/desktop/win/inno"
          $ver    = $env:VERSION
          $build  = $env:BUILD
          $edition= $env:PRODUCT_EDITION
        
          $file = "ONLYOFFICE-DesktopEditors$edition-$ver.$build-x64.exe"
          $fileName = "ONLYOFFICE-DesktopEditors-$ver.$build-x64.exe"
        
          Write-Host "Downloading $file"
          curl -L "$url/$file" -o $fileName
         
    - name: Install
      shell: cmd
      run: |
           ONLYOFFICE-DesktopEditors-9.3.0.49-x64.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /DS_PORT=8200 /LOG="C:\desktop-install-log%EDITION%.txt"

    - name: Verify
      run: |
         if (!(Test-Path "C:\Program Files\ONLYOFFICE\DesktopEditors")) {
              Write-Error "App not installed!"
         }

         Write-Host "Files in DesktopEditors:"
         ls "C:\Program Files\ONLYOFFICE\DesktopEditors"

    - name: Check version and run binary headless
      shell: pwsh
      run: |
          $exe = "C:\Program Files\ONLYOFFICE\DesktopEditors\DesktopEditors.exe"
          if (!(Test-Path $exe)) {
            Write-Error "Executable not found!"
          }
          
          Write-Host "=== Version Info ==="
          (Get-Item $exe).VersionInfo

          Write-Host "=== Running DesktopEditors in headless mode ==="
          Start-Process -FilePath $exe -ArgumentList "--help" -NoNewWindow -Wait
          Write-Host "Exit code: $LASTEXITCODE"    

    - name: Upload install log
      if: always()
      uses: actions/upload-artifact@v4
      with:
         name: desktop-install-log${{ matrix.edition }}
         path: C:\desktop-install-log${{ matrix.edition }}.txt
