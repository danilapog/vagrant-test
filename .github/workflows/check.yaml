name: Docs Test EXE (amd64/arm64)

run-name: >-
    CI Docs Windows [Build #${{ inputs.build }} 
                          Arch: ${{ inputs.arch }} 
                          Version: ${{ inputs.version }}
                    ]
                    [
                    ${{ inputs.community && 'CE' || '-' }}
                    ${{ inputs.developer && 'DE' || '-' }}
                    ${{ inputs.enterprise && 'EE' || '-' }}
                    ]

on:
  push:
  workflow_dispatch:
    inputs:
      build:
        description: 'Please specify windows package build'
        type: string
        required: true
      version:
        description: 'Please specify windows package version'
        type: string
        required: true
      arch:
        type: string
        description: 'Type arch amd64 or arm64'
        required: true
      community:
        type: boolean
        description: 'Test Exe Community Edition'
        default: true
      enterprise:
        type: boolean
        description: 'Test Exe Enterprise Edition'
        default: true
      developer:
        type: boolean
        description: 'Test Exe Developer Edition'
        default: true
  
jobs:
  test:
    name: test
    #name: "Test Win Docs-${{ matrix.edition }}-${{ matrix.arch }}"
    runs-on: ${{ (github.event.inputs.arch == 'arm64') && 'windows-11-arm' || 'windows-latest' }}
    steps:
      - name: Download
        run: |
           curl -L "${{ secrets.PACKAGE_URL }}/ONLYOFFICE-DocumentServer-Prerequisites-9.2.0.80-x64.exe -o ONLYOFFICE-DocumentServer-Prerequisites-9.2.0.80-x64.exe 
           curl -L "${{ secrets.PACKAGE_URL }}/ONLYOFFICE-DocumentServer-9.2.0.80-x64.exe" -o ONLYOFFICE-DocumentServer-9.2.0.80-x64.exe
           

      - name: Install
        shell: cmd
        run: |
           ONLYOFFICE-DocumentServer-Prerequisites-9.2.0.80-x64.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /LOG="C:\install-log-rpeq.txt"
           ONLYOFFICE-DocumentServer-9.2.0.80-x64.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /DS_PORT=8200 /LOG="C:\install-log.txt"
           echo Exit code: %ERRORLEVEL%
    
      - name: Verify
        run: |
         ls "C:\Program Files\ONLYOFFICE\DocumentServer"
         if (!(Test-Path "C:\Program Files\ONLYOFFICE\DocumentServer")) {
              Write-Error "App not installed!"
         }

         Write-Host "== Running services =="
         Get-Service -ErrorAction SilentlyContinue | Where-Object { $_.Status -eq "Running" }
    
         Write-Host "== ONLYOFFICE services =="
         Get-Service -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*onlyoffice*" -or $_.DisplayName -like "*onlyoffice*" }
    
         Write-Host "== Processes =="
         Get-Process
    
         Write-Host "== Open ports =="
         netstat -ano

      - name: get logs
        run: |
          $logRoot = "C:\Program Files\ONLYOFFICE\DocumentServer\Log"
          $nginxLogs = "C:\Program Files\ONLYOFFICE\DocumentServer\nginx\logs"
            
          Write-Host "=== NGINX LOGS ==="
          if (Test-Path $nginxLogs) {
              Get-ChildItem -Recurse $nginxLogs | ForEach-Object {
                  if (-not $_.PSIsContainer) {
                      Write-Host "`n--- $($_.FullName) ---"
                      try { Get-Content $_.FullName -ErrorAction Stop }
                      catch { Write-Host "ERROR: $($_.Exception.Message)" }
                  }
              }
          }
            
          Write-Host "`n=== DOCUMENTSERVER LOGS ==="
          if (Test-Path $logRoot) {
              Get-ChildItem -Recurse $logRoot | ForEach-Object {
                  if (-not $_.PSIsContainer) {
                      Write-Host "`n--- $($_.FullName) ---"
                      try { Get-Content $_.FullName -ErrorAction Stop }
                      catch { Write-Host "ERROR: $($_.Exception.Message)" }
                  }
              }
          } else {
              Write-Host "Log root directory not found: $logRoot"
          }
            
      - name: Wait for healthcheck (with detailed logging)
        if: ${{ false }}
        shell: pwsh
        run: |
            $timeout = 30     # 5 минут
            $interval = 5      # каждые 5 секунд
            $elapsed = 0
        
            Write-Host "Waiting for healthcheck at http://localhost:8200/healthcheck ..."
        
            while ($elapsed -lt $timeout) {
                try {
                    $response = Invoke-WebRequest -Uri "http://localhost:8200/healthcheck" -UseBasicParsing -TimeoutSec 2
                    $body = $response.Content.Trim()
        
                    Write-Host "[$elapsed sec] Got response:"
                    Write-Host "  StatusCode: $($response.StatusCode)"
                    Write-Host "  Body: '$body'"
        
                    if ($body -eq "true") {
                        Write-Host "Healthcheck OK!"
                        exit 0
                    }
                }
                catch {
                    Write-Host "[$elapsed sec] ERROR calling endpoint:"
                    Write-Host "  $($_.Exception.Message)"
                }
        
                Start-Sleep -Seconds $interval
                $elapsed += $interval
            }
        
            Write-Error "Service did NOT return 'true' within 5 minutes!"
            exit 1
